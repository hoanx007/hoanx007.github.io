<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ƒê·ªÅ Thi T·ªïng H·ª£p To√°n H·ªçc L·ªõp 4</title>
    <link rel="icon" type="image/svg+xml" href="favicon.svg">
    <link rel="apple-touch-icon" href="favicon.svg">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #ff6b6b, #feca57);
            color: white;
            text-align: center;
            padding: 30px 20px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .timer-display {
            background: #fff3cd;
            color: #856404;
            padding: 10px 15px;
            border-radius: 8px;
            font-weight: bold;
            margin-top: 10px;
            border: 2px solid #ffc107;
            display: none;
        }

        .exam-info {
            background: #e3f2fd;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border: 2px solid #bbdefb;
        }

        .exam-info h3 {
            color: #1565c0;
            margin-bottom: 15px;
        }

        .exam-info ul {
            color: #0d47a1;
            margin-left: 20px;
        }

        .exam-info li {
            margin: 5px 0;
        }

        .exam-selector {
            padding: 30px;
            background: #f8f9fa;
        }

        .exam-selector h3 {
            text-align: center;
            color: #2c3e50;
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .exam-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .exam-option {
            padding: 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .exam-option:hover {
            border-color: #007bff;
            background: #e3f2fd;
            transform: translateY(-2px);
        }

        .exam-option.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .start-section {
            text-align: center;
            padding: 30px;
        }

        .start-btn {
            padding: 20px 40px;
            font-size: 1.3em;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(40,167,69,0.3);
        }

        .start-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(40,167,69,0.4);
        }

        .start-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .progress-info {
            background: #f8f9fa;
            padding: 15px 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 999;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-bottom: 2px solid #dee2e6;
        }

        .progress-bar {
            width: 100%;
            max-width: 600px;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
            margin: 0 auto 10px auto;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            width: 0%;
            transition: width 0.5s ease;
            border-radius: 10px;
        }

        .progress-info p {
            font-weight: bold;
            color: #495057;
            margin: 0;
        }

        .exam-section {
            display: none;
            padding: 20px 0;
        }

        .exam-section.active {
            display: block;
        }

        #questions-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .section-header {
            background: #f8f9fa;
            padding: 15px 20px;
            margin: 20px 0;
            border-radius: 10px;
            border-left: 5px solid #007bff;
        }

        .section-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #007bff;
            margin-bottom: 5px;
        }

        .section-description {
            color: #6c757d;
            font-size: 0.95em;
        }

        .question {
            background: #f8f9fa;
            margin: 15px 0;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #28a745;
        }

        .question-number {
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }

        .question-text {
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .choices {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .choice {
            padding: 12px 15px;
            background: white;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .choice:hover {
            border-color: #007bff;
            background: #e3f2fd;
        }

        .choice.selected {
            background: #007bff;
            color: white;
            border-color: #0056b3;
        }

        .choice.correct {
            background: #28a745;
            color: white;
            border-color: #1e7e34;
        }

        .choice.incorrect {
            background: #dc3545;
            color: white;
            border-color: #bd2130;
        }

        .submit-section {
            text-align: center;
            margin: 30px auto;
            max-width: 900px;
            padding: 0 20px;
        }

        .submit-btn {
            padding: 15px 40px;
            font-size: 1.2em;
            background: #dc3545;
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .submit-btn:hover {
            background: #c82333;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220,53,69,0.3);
        }

        .result-section {
            display: none;
            text-align: center;
            padding: 20px;
            background: #e8f5e8;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 900px;
        }

        .score {
            font-size: 2em;
            font-weight: bold;
            color: #28a745;
            margin-bottom: 10px;
        }

        .rating {
            font-size: 1.3em;
            margin-bottom: 15px;
        }

        .back-btn {
            padding: 10px 20px;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            margin: 5px;
        }

        .back-btn:hover {
            background: #545b62;
        }

        .home-btn {
            background: #6c757d;
            color: white;
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
        }

        .home-btn:hover {
            background: #545b62;
            transform: translateY(-1px);
        }

        .results-history {
            background: #f8f9fa;
            padding: 20px;
            margin: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }

        .results-history h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            text-align: center;
        }

        .result-item {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #007bff;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .result-info {
            flex: 1;
        }

        .result-score {
            font-weight: bold;
            font-size: 1.1em;
        }

        .result-time {
            color: #6c757d;
            font-size: 0.9em;
        }

        .clear-history-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        /* Desktop specific styles */
        @media (min-width: 769px) {
            .container {
                max-width: 1000px;
                margin: 0 auto;
            }

            #questions-container {
                max-width: 900px;
                margin: 0 auto;
                padding: 0 40px;
            }

            .submit-section {
                max-width: 900px;
                margin: 30px auto;
                padding: 0 40px;
            }

            .result-section {
                max-width: 900px;
                margin: 20px auto;
                padding: 20px 40px;
            }

            .progress-info {
                padding: 15px 40px;
            }

            .exam-section {
                padding: 20px 0;
            }
        }

        @media (max-width: 768px) {
            .container {
                margin: 10px;
                border-radius: 15px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .choices {
                grid-template-columns: 1fr;
            }
            
            .choice {
                font-size: 1em;
                padding: 10px;
            }

            .exam-grid {
                grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
                gap: 10px;
            }

            .exam-option {
                padding: 10px;
                font-size: 0.9em;
            }

            .timer-display {
                margin-left: 0;
                margin-top: 10px;
            }

            .result-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            #questions-container {
                padding: 0 10px;
            }

            .progress-info {
                padding: 10px 15px;
            }

            .header {
                padding: 20px 15px;
            }

            .exam-section {
                padding: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header" id="main-header">
            <h1>üìã ƒê·ªÅ Thi T·ªïng H·ª£p To√°n H·ªçc L·ªõp 4</h1>
            <p>üéØ Ki·ªÉm tra to√†n di·ªán ki·∫øn th·ª©c to√°n h·ªçc l·ªõp 4</p>
            <div style="margin-top: 15px;">
                <button class="home-btn" onclick="goHome()">üè† V·ªÅ trang ch·ªß</button>
            </div>
            <div class="timer-display" id="timer-display">
                ‚è∞ Th·ªùi gian: <span id="timer">00:00</span>
            </div>
        </div>

        <div id="intro-section">
            <div class="exam-info">
                <h3>üìö C·∫•u tr√∫c ƒë·ªÅ thi:</h3>
                <ul>
                    <li><strong>Ph·∫ßn 1:</strong> Tr·∫Øc nghi·ªám S·ªë h·ªçc (5 c√¢u)</li>
                    <li><strong>Ph·∫ßn 2:</strong> Tr·∫Øc nghi·ªám ƒê·∫°i l∆∞·ª£ng v√† ƒëo l∆∞·ªùng (4 c√¢u)</li>
                    <li><strong>Ph·∫ßn 3:</strong> Tr·∫Øc nghi·ªám H√¨nh h·ªçc (4 c√¢u)</li>
                    <li><strong>Ph·∫ßn 4:</strong> Gi·∫£i to√°n c√≥ l·ªùi vƒÉn (5 c√¢u)</li>
                    <li><strong>Ph·∫ßn 5:</strong> T∆∞ duy logic, n√¢ng cao (2 c√¢u)</li>
                </ul>
                <br>
                <p><strong>‚è∞ Th·ªùi gian:</strong> 60 ph√∫t | <strong>üìä T·ªïng s·ªë c√¢u:</strong> 20 c√¢u | <strong>üéØ ƒêi·ªÉm t·ªëi ƒëa:</strong> 20 ƒëi·ªÉm</p>
            </div>

            <div class="exam-selector">
                <h3>üéØ Ch·ªçn ƒë·ªÅ thi (40 ƒë·ªÅ kh√°c nhau)</h3>
                <div class="exam-grid" id="exam-grid">
                    <!-- S·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                </div>
                <div class="start-section">
                    <button class="start-btn" id="start-btn" onclick="startExam()" disabled>üöÄ B·∫Øt ƒë·∫ßu l√†m b√†i</button>
                </div>
            </div>

            <div class="results-history" id="results-history">
                <h3>üìä L·ªãch s·ª≠ k·∫øt qu·∫£</h3>
                <div id="history-list">
                    <!-- S·∫Ω ƒë∆∞·ª£c t·∫°o b·∫±ng JavaScript -->
                </div>
                <div style="text-align: center; margin-top: 15px;">
                    <button class="clear-history-btn" onclick="clearHistory()">üóëÔ∏è X√≥a l·ªãch s·ª≠</button>
                </div>
            </div>
        </div>

        <div class="exam-section" id="exam-content">
            <div class="progress-info" id="progress-info">
                <div class="progress-bar">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
                <p>Ti·∫øn ƒë·ªô: <span id="progress-text">0/20 c√¢u</span></p>
            </div>

            <div id="questions-container"></div>

            <div class="submit-section">
                <button class="submit-btn" onclick="submitExam()">üìù N·ªôp b√†i thi</button>
            </div>

            <div class="result-section" id="result-section"></div>
        </div>
    </div>

    <script>
        // H√†m t·∫°o s·ªë ng·∫´u nhi√™n
        function getRandomNumber(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // H√†m t·∫°o ƒë√°p √°n sai kh√¥ng tr√πng l·∫∑p - c·∫£i thi·ªán
        function generateUniqueWrongAnswers(correctAnswer, count = 3, range = { min: 100, max: 1000 }) {
            const wrongAnswers = new Set();
            const attempts = 200; // TƒÉng s·ªë l·∫ßn th·ª≠
            let currentAttempt = 0;
            
            // ƒê·∫£m b·∫£o correctAnswer l√† s·ªë
            const correct = typeof correctAnswer === 'string' ? parseFloat(correctAnswer) : correctAnswer;
            
            // T·∫°o c√°c ƒë√°p √°n sai v·ªõi nhi·ªÅu ph∆∞∆°ng ph√°p kh√°c nhau
            const methods = [
                () => correct + getRandomNumber(range.min, range.max),
                () => Math.max(1, correct - getRandomNumber(range.min, range.max)),
                () => Math.floor(correct * (1 + getRandomNumber(10, 50) / 100)),
                () => Math.max(1, Math.floor(correct * (1 - getRandomNumber(10, 30) / 100))),
                () => correct + getRandomNumber(-range.max, range.max),
                () => Math.max(1, correct + getRandomNumber(-range.min, range.min)),
                () => Math.floor(correct * 1.5),
                () => Math.floor(correct * 0.7),
                () => correct + 500,
                () => Math.max(1, correct - 300)
            ];
            
            while (wrongAnswers.size < count && currentAttempt < attempts) {
                const method = methods[currentAttempt % methods.length];
                const wrongAnswer = Math.floor(method());
                
                // ƒê·∫£m b·∫£o ƒë√°p √°n sai kh√°c ƒë√°p √°n ƒë√∫ng v√† kh√¥ng tr√πng l·∫∑p
                if (wrongAnswer !== correct && wrongAnswer > 0 && !wrongAnswers.has(wrongAnswer)) {
                    wrongAnswers.add(wrongAnswer);
                }
                currentAttempt++;
            }
            
            // N·∫øu v·∫´n kh√¥ng ƒë·ªß, t·∫°o ƒë√°p √°n c·ªë ƒë·ªãnh
            const fallbackAnswers = [
                Math.floor(correct * 2),
                Math.floor(correct * 0.5),
                correct + 1000,
                Math.max(1, correct - 500),
                correct + 123,
                correct + 456
            ];
            
            for (const fallback of fallbackAnswers) {
                if (wrongAnswers.size >= count) break;
                if (fallback !== correct && fallback > 0 && !wrongAnswers.has(fallback)) {
                    wrongAnswers.add(fallback);
                }
            }
            
            return Array.from(wrongAnswers).slice(0, count);
        }

        // H√†m tr·ªôn m·∫£ng
        function shuffleArray(array) {
            const newArray = [...array];
            for (let i = newArray.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [newArray[i], newArray[j]] = [newArray[j], newArray[i]];
            }
            return newArray;
        }

        // T·∫°o c√¢u h·ªèi cho Ph·∫ßn 1: S·ªë h·ªçc (5 c√¢u)
        function generateMathQuestions() {
            const questions = [];
            
            // C√¢u 1: Ph√©p c·ªông s·ªë c√≥ nhi·ªÅu ch·ªØ s·ªë
            const a1 = getRandomNumber(1234, 8999);
            const b1 = getRandomNumber(1234, 8999);
            const sum = a1 + b1;
            const wrongAnswers1 = generateUniqueWrongAnswers(sum, 3, { min: 100, max: 2000 });
            const choices1 = shuffleArray([sum, ...wrongAnswers1]);
            questions.push({
                q: `T√≠nh: ${a1.toLocaleString()} + ${b1.toLocaleString()} = ?`,
                choices: choices1.map(n => n.toLocaleString()),
                correct: choices1.indexOf(sum)
            });

            // C√¢u 2: Ph√©p tr·ª´ s·ªë c√≥ nhi·ªÅu ch·ªØ s·ªë - ƒë·∫£m b·∫£o k·∫øt qu·∫£ d∆∞∆°ng
            const a2 = getRandomNumber(6000, 9999);
            const b2 = getRandomNumber(1000, 5999); // ƒê·∫£m b·∫£o a2 > b2
            const diff = a2 - b2;
            const wrongAnswers2 = generateUniqueWrongAnswers(diff, 3, { min: 200, max: 1500 });
            const choices2 = shuffleArray([diff, ...wrongAnswers2]);
            questions.push({
                q: `T√≠nh: ${a2.toLocaleString()} - ${b2.toLocaleString()} = ?`,
                choices: choices2.map(n => n.toLocaleString()),
                correct: choices2.indexOf(diff)
            });

            // C√¢u 3: Ph√©p nh√¢n
            const a3 = getRandomNumber(123, 999);
            const b3 = getRandomNumber(2, 12);
            const product = a3 * b3;
            const wrongAnswers3 = generateUniqueWrongAnswers(product, 3, { min: 100, max: 2000 });
            const choices3 = shuffleArray([product, ...wrongAnswers3]);
            questions.push({
                q: `T√≠nh: ${a3} √ó ${b3} = ?`,
                choices: choices3.map(n => n.toLocaleString()),
                correct: choices3.indexOf(product)
            });

            // C√¢u 4: Ph√©p chia - ƒë·∫£m b·∫£o chia h·∫øt
            const divisor = getRandomNumber(12, 25);
            const quotient = getRandomNumber(45, 150);
            const dividend = divisor * quotient; // ƒê·∫£m b·∫£o chia h·∫øt
            const wrongAnswers4 = generateUniqueWrongAnswers(quotient, 3, { min: 10, max: 100 });
            const choices4 = shuffleArray([quotient, ...wrongAnswers4]);
            questions.push({
                q: `T√≠nh: ${dividend} √∑ ${divisor} = ?`,
                choices: choices4.map(n => n.toString()),
                correct: choices4.indexOf(quotient)
            });

            // C√¢u 5: So s√°nh s·ªë
            const numbers = [];
            const baseNumber = getRandomNumber(8000, 9000);
            for (let i = 0; i < 4; i++) {
                numbers.push(baseNumber + getRandomNumber(i * 100, (i + 1) * 100));
            }
            const maxNumber = Math.max(...numbers);
            const shuffledNumbers = shuffleArray(numbers);
            questions.push({
                q: `S·ªë n√†o l·ªõn nh·∫•t trong c√°c s·ªë sau: ${numbers.join(', ')}?`,
                choices: shuffledNumbers.map(n => n.toString()),
                correct: shuffledNumbers.indexOf(maxNumber)
            });

            return questions;
        }

        // T·∫°o c√¢u h·ªèi cho Ph·∫ßn 2: ƒê·∫°i l∆∞·ª£ng v√† ƒëo l∆∞·ªùng (4 c√¢u)
        function generateMeasurementQuestions() {
            const questions = [];
            
            // C√¢u 1: Chuy·ªÉn ƒë·ªïi ƒë∆°n v·ªã ƒë·ªô d√†i
            const m = getRandomNumber(3, 9);
            const dm = getRandomNumber(1, 9);
            const cm = getRandomNumber(10, 99);
            const totalCm = m * 100 + dm * 10 + cm;
            
            // T·∫°o ƒë√°p √°n sai ƒë·∫£m b·∫£o kh√¥ng tr√πng l·∫∑p
            const wrongAnswers1 = [];
            
            // ƒê√°p √°n sai 1: N·ªëi s·ªë
            const concatenated1 = parseInt(`${m}${dm}${cm}`);
            wrongAnswers1.push(`${concatenated1} cm`);
            
            // ƒê√°p √°n sai 2: C·ªông ƒë∆°n gi·∫£n
            wrongAnswers1.push(`${m + dm + cm} cm`);
            
            // ƒê√°p √°n sai 3: T·∫°o s·ªë kh√°c bi·ªát
            let wrongAnswer1_3;
            do {
                wrongAnswer1_3 = totalCm + getRandomNumber(50, 200);
            } while (wrongAnswer1_3 === totalCm || wrongAnswer1_3 === concatenated1 || wrongAnswer1_3 === (m + dm + cm));
            
            wrongAnswers1.push(`${wrongAnswer1_3} cm`);
            
            const allChoices1 = [`${totalCm} cm`, ...wrongAnswers1];
            const choices1 = shuffleArray(allChoices1);
            const correctIndex1 = choices1.indexOf(`${totalCm} cm`);
            
            questions.push({
                q: `${m} m√©t ${dm} ƒë·ªÅxim√©t ${cm} centim√©t b·∫±ng bao nhi√™u centim√©t?`,
                choices: choices1,
                correct: correctIndex1
            });

            // C√¢u 2: Chu vi h√¨nh ch·ªØ nh·∫≠t
            const length = getRandomNumber(8, 20);
            const width = getRandomNumber(5, 15);
            const perimeter = 2 * (length + width);
            
            const wrongAnswers2 = [];
            
            // ƒê√°p √°n sai 1: Ch·ªâ c·ªông
            wrongAnswers2.push(`${length + width} m`);
            
            // ƒê√°p √°n sai 2: Di·ªán t√≠ch
            wrongAnswers2.push(`${length * width} m`);
            
            // ƒê√°p √°n sai 3: T·∫°o s·ªë kh√°c bi·ªát
            let wrongAnswer2_3;
            do {
                wrongAnswer2_3 = perimeter + getRandomNumber(2, 8);
            } while (wrongAnswer2_3 === perimeter || wrongAnswer2_3 === (length + width) || wrongAnswer2_3 === (length * width));
            
            wrongAnswers2.push(`${wrongAnswer2_3} m`);
            
            const allChoices2 = [`${perimeter} m`, ...wrongAnswers2];
            const choices2 = shuffleArray(allChoices2);
            const correctIndex2 = choices2.indexOf(`${perimeter} m`);
            
            questions.push({
                q: `Chu vi h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i ${length}m, chi·ªÅu r·ªông ${width}m l√†:`,
                choices: choices2,
                correct: correctIndex2
            });

            // C√¢u 3: Chuy·ªÉn ƒë·ªïi kh·ªëi l∆∞·ª£ng
            const kg = getRandomNumber(2, 8);
            const g = getRandomNumber(100, 900);
            const totalG = kg * 1000 + g;
            
            // T·∫°o ƒë√°p √°n sai ƒë·∫£m b·∫£o kh√¥ng tr√πng l·∫∑p
            const wrongAnswers3 = [];
            const usedAnswers3 = new Set([totalG]);
            
            // ƒê√°p √°n sai 1: N·ªëi s·ªë
            const concatenated = parseInt(`${kg}${g}`);
            if (!usedAnswers3.has(concatenated)) {
                wrongAnswers3.push(`${concatenated} g`);
                usedAnswers3.add(concatenated);
            }
            
            // ƒê√°p √°n sai 2: C·ªông ƒë∆°n gi·∫£n
            const simpleSum = kg + g;
            if (!usedAnswers3.has(simpleSum)) {
                wrongAnswers3.push(`${simpleSum} g`);
                usedAnswers3.add(simpleSum);
            }
            
            // ƒê√°p √°n sai 3: T·∫°o s·ªë kh√°c bi·ªát
            let attempts3 = 0;
            while (wrongAnswers3.length < 3 && attempts3 < 50) {
                let candidate;
                const method = attempts3 % 4;
                
                switch(method) {
                    case 0:
                        candidate = totalG + getRandomNumber(100, 500);
                        break;
                    case 1:
                        candidate = Math.max(100, totalG - getRandomNumber(100, 500));
                        break;
                    case 2:
                        candidate = Math.floor(totalG * 1.2);
                        break;
                    case 3:
                        candidate = Math.floor(totalG * 0.8);
                        break;
                }
                
                if (!usedAnswers3.has(candidate) && candidate > 0) {
                    wrongAnswers3.push(`${candidate} g`);
                    usedAnswers3.add(candidate);
                }
                attempts3++;
            }
            
            // Fallback n·∫øu kh√¥ng ƒë·ªß ƒë√°p √°n
            const fallbacks3 = [totalG + 1000, totalG - 500, totalG * 2, Math.floor(totalG / 2)];
            for (const fallback of fallbacks3) {
                if (wrongAnswers3.length >= 3) break;
                if (!usedAnswers3.has(fallback) && fallback > 0) {
                    wrongAnswers3.push(`${fallback} g`);
                    usedAnswers3.add(fallback);
                }
            }
            
            // ƒê·∫£m b·∫£o c√≥ ƒë·ªß 3 ƒë√°p √°n sai
            while (wrongAnswers3.length < 3) {
                const random = totalG + getRandomNumber(1000, 2000);
                if (!usedAnswers3.has(random)) {
                    wrongAnswers3.push(`${random} g`);
                    usedAnswers3.add(random);
                }
            }
            
            const allChoices3 = [`${totalG} g`, ...wrongAnswers3.slice(0, 3)];
            const choices3 = shuffleArray(allChoices3);
            const correctIndex3 = choices3.indexOf(`${totalG} g`);
            
            questions.push({
                q: `${kg} kg ${g} g b·∫±ng bao nhi√™u gam?`,
                choices: choices3,
                correct: correctIndex3
            });

            // C√¢u 4: Di·ªán t√≠ch h√¨nh vu√¥ng
            const side = getRandomNumber(6, 15);
            const area = side * side;
            
            const wrongAnswers4 = [];
            
            // ƒê√°p √°n sai 1: Chu vi
            wrongAnswers4.push(`${side * 4} cm¬≤`);
            
            // ƒê√°p √°n sai 2: Nh√¢n 2
            wrongAnswers4.push(`${side * 2} cm¬≤`);
            
            // ƒê√°p √°n sai 3: T·∫°o s·ªë kh√°c bi·ªát
            let wrongAnswer4_3;
            do {
                wrongAnswer4_3 = area + getRandomNumber(10, 50);
            } while (wrongAnswer4_3 === area || wrongAnswer4_3 === (side * 4) || wrongAnswer4_3 === (side * 2));
            
            wrongAnswers4.push(`${wrongAnswer4_3} cm¬≤`);
            
            const allChoices4 = [`${area} cm¬≤`, ...wrongAnswers4];
            const choices4 = shuffleArray(allChoices4);
            const correctIndex4 = choices4.indexOf(`${area} cm¬≤`);
            
            questions.push({
                q: `Di·ªán t√≠ch h√¨nh vu√¥ng c√≥ c·∫°nh ${side} cm l√†:`,
                choices: choices4,
                correct: correctIndex4
            });

            return questions;
        }

        // T·∫°o c√¢u h·ªèi cho Ph·∫ßn 3: H√¨nh h·ªçc (4 c√¢u)
        function generateGeometryQuestions() {
            const questions = [];

            // C√¢u 1: Nh·∫≠n bi·∫øt h√¨nh
            const choices1 = shuffleArray([
                "4 c·∫°nh b·∫±ng nhau v√† 4 g√≥c vu√¥ng",
                "4 c·∫°nh b·∫±ng nhau nh∆∞ng kh√¥ng c√≥ g√≥c vu√¥ng",
                "2 c·∫∑p c·∫°nh ƒë·ªëi b·∫±ng nhau",
                "3 c·∫°nh b·∫±ng nhau"
            ]);
            questions.push({
                q: "H√¨nh vu√¥ng c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨?",
                choices: choices1,
                correct: choices1.indexOf("4 c·∫°nh b·∫±ng nhau v√† 4 g√≥c vu√¥ng")
            });

            // C√¢u 2: ƒê∆∞·ªùng th·∫≥ng song song
            const choices2 = shuffleArray([
                "Kh√¥ng bao gi·ªù c·∫Øt nhau",
                "C·∫Øt nhau t·∫°i 1 ƒëi·ªÉm",
                "C·∫Øt nhau t·∫°i 2 ƒëi·ªÉm",
                "Tr√πng nhau"
            ]);
            questions.push({
                q: "Hai ƒë∆∞·ªùng th·∫≥ng song song c√≥ t√≠nh ch·∫•t g√¨?",
                choices: choices2,
                correct: choices2.indexOf("Kh√¥ng bao gi·ªù c·∫Øt nhau")
            });

            // C√¢u 3: Di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t
            const length = getRandomNumber(12, 25);
            const width = getRandomNumber(6, 15);
            const area = length * width;
            const wrongAnswers3 = [
                `${2 * (length + width)} cm¬≤`,
                `${length + width} cm¬≤`,
                `${area + 50} cm¬≤`
            ];
            const choices3 = shuffleArray([`${area} cm¬≤`, ...wrongAnswers3]);
            questions.push({
                q: `Di·ªán t√≠ch h√¨nh ch·ªØ nh·∫≠t d√†i ${length} cm, r·ªông ${width} cm l√†:`,
                choices: choices3,
                correct: choices3.indexOf(`${area} cm¬≤`)
            });

            // C√¢u 4: H√¨nh thoi
            const choices4 = shuffleArray([
                "4 c·∫°nh b·∫±ng nhau",
                "4 g√≥c vu√¥ng",
                "2 c·∫∑p c·∫°nh ƒë·ªëi b·∫±ng nhau",
                "3 c·∫°nh b·∫±ng nhau"
            ]);
            questions.push({
                q: "H√¨nh thoi c√≥ ƒë·∫∑c ƒëi·ªÉm g√¨?",
                choices: choices4,
                correct: choices4.indexOf("4 c·∫°nh b·∫±ng nhau")
            });

            return questions;
        }

        // T·∫°o c√¢u h·ªèi cho Ph·∫ßn 4: Gi·∫£i to√°n c√≥ l·ªùi vƒÉn (5 c√¢u) - s·ª≠a l·∫°i
        function generateWordProblems() {
            const questions = [];

            // C√¢u 1: T√¨m m·ªôt ph·∫ßn c·ªßa m·ªôt s·ªë - ƒë·∫£m b·∫£o chia h·∫øt
            const fractions = [2, 3, 4, 5, 6];
            const fraction = fractions[getRandomNumber(0, fractions.length - 1)];
            const part = getRandomNumber(20, 80);
            const total1 = part * fraction;
            const remaining = total1 - part;
            
            const wrongAnswers1 = [
                `${part} quy·ªÉn`,
                `${Math.floor(total1 / 2)} quy·ªÉn`,
                `${total1 - getRandomNumber(30, 70)} quy·ªÉn`
            ];
            
            const allChoices1 = [`${remaining} quy·ªÉn`, ...wrongAnswers1];
            const choices1 = shuffleArray(allChoices1);
            
            questions.push({
                q: `M·ªôt th∆∞ vi·ªán c√≥ ${total1} quy·ªÉn s√°ch. Cho m∆∞·ª£n ƒëi 1/${fraction} s·ªë s√°ch. H·ªèi th∆∞ vi·ªán c√≤n l·∫°i bao nhi√™u quy·ªÉn s√°ch?`,
                choices: choices1,
                correct: choices1.indexOf(`${remaining} quy·ªÉn`)
            });

            // C√¢u 2: T√¨m s·ªë khi bi·∫øt gi√° tr·ªã c·ªßa m·ªôt ph√¢n s·ªë - ƒë·∫£m b·∫£o chia h·∫øt
            const childAge = getRandomNumber(8, 16);
            const motherAge = childAge * 3;
            
            const wrongAnswers2 = [
                `${childAge + getRandomNumber(1, 3)} tu·ªïi`,
                `${Math.max(1, childAge - getRandomNumber(1, 3))} tu·ªïi`,
                `${Math.floor(motherAge / 4)} tu·ªïi`
            ];
            
            const allChoices2 = [`${childAge} tu·ªïi`, ...wrongAnswers2];
            const choices2 = shuffleArray(allChoices2);
            
            questions.push({
                q: `Tu·ªïi con b·∫±ng 1/3 tu·ªïi m·∫π. M·∫π ${motherAge} tu·ªïi. H·ªèi con bao nhi√™u tu·ªïi?`,
                choices: choices2,
                correct: choices2.indexOf(`${childAge} tu·ªïi`)
            });

            // C√¢u 3: B√†i to√°n t·ªâ s·ªë, t·ªïng-hi·ªáu - ƒë·∫£m b·∫£o chia h·∫øt
            const ratio = getRandomNumber(2, 4);
            const smaller = getRandomNumber(15, 25);
            const larger = smaller * ratio;
            const sum = smaller + larger;
            
            const wrongAnswers3 = [
                `${larger}`,
                `${Math.floor(sum / 2)}`,
                `${smaller + getRandomNumber(5, 15)}`
            ];
            
            const allChoices3 = [`${smaller}`, ...wrongAnswers3];
            const choices3 = shuffleArray(allChoices3);
            
            questions.push({
                q: `T·ªïng hai s·ªë l√† ${sum}. S·ªë th·ª© nh·∫•t g·∫•p ${ratio} l·∫ßn s·ªë th·ª© hai. S·ªë th·ª© hai l√†:`,
                choices: choices3,
                correct: choices3.indexOf(`${smaller}`)
            });

            // C√¢u 4: B√†i to√°n chuy·ªÉn ƒë·ªông - ƒë·∫£m b·∫£o s·ªë nguy√™n
            const speed = getRandomNumber(40, 80);
            const time = getRandomNumber(2, 6);
            const distance = speed * time;
            
            const wrongAnswers4 = [
                `${speed + time} km`,
                `${Math.abs(speed - time)} km`,
                `${distance + getRandomNumber(20, 80)} km`
            ];
            
            const allChoices4 = [`${distance} km`, ...wrongAnswers4];
            const choices4 = shuffleArray(allChoices4);
            
            questions.push({
                q: `M·ªôt xe m√°y ch·∫°y v·ªõi v·∫≠n t·ªëc ${speed} km/gi·ªù trong ${time} gi·ªù. Qu√£ng ƒë∆∞·ªùng xe m√°y ƒëi ƒë∆∞·ª£c l√†:`,
                choices: choices4,
                correct: choices4.indexOf(`${distance} km`)
            });

            // C√¢u 5: B√†i to√°n di·ªán t√≠ch th·ª±c t·∫ø
            const length = getRandomNumber(20, 40);
            const width = getRandomNumber(10, 25);
            const area = length * width;
            
            const wrongAnswers5 = [
                `${2 * (length + width)} m¬≤`,
                `${length + width} m¬≤`,
                `${area + getRandomNumber(50, 150)} m¬≤`
            ];
            
            const allChoices5 = [`${area} m¬≤`, ...wrongAnswers5];
            const choices5 = shuffleArray(allChoices5);
            
            questions.push({
                q: `M·ªôt khu v∆∞·ªùn h√¨nh ch·ªØ nh·∫≠t c√≥ chi·ªÅu d√†i ${length}m, chi·ªÅu r·ªông ${width}m. Di·ªán t√≠ch khu v∆∞·ªùn l√†:`,
                choices: choices5,
                correct: choices5.indexOf(`${area} m¬≤`)
            });

            return questions;
        }

        // T·∫°o c√¢u h·ªèi cho Ph·∫ßn 5: T∆∞ duy logic (2 c√¢u) - s·ª≠a l·∫°i
        function generateLogicQuestions() {
            const questions = [];

            // C√¢u 1: T√¨m quy lu·∫≠t d√£y s·ªë - ƒë·∫£m b·∫£o s·ªë t·ª± nhi√™n
            const start = getRandomNumber(2, 10);
            const step = getRandomNumber(2, 8);
            const sequence = [start, start + step, start + 2*step, start + 3*step, start + 4*step];
            const correctAnswer = sequence[4];
            
            const wrongAnswers1 = [
                correctAnswer + step + getRandomNumber(1, 3),
                Math.max(1, correctAnswer - step + getRandomNumber(1, 3)),
                correctAnswer + step * 2
            ];
            
            const allChoices1 = [correctAnswer, ...wrongAnswers1];
            const choices1 = shuffleArray(allChoices1);
            
            questions.push({
                q: `T√¨m s·ªë ti·∫øp theo trong d√£y: ${sequence.slice(0, 4).join(', ')}, ?`,
                choices: choices1.map(n => n.toString()),
                correct: choices1.indexOf(correctAnswer)
            });

            // C√¢u 2: To√°n ƒë·ªë logic - ƒë·∫£m b·∫£o k·∫øt qu·∫£ l√† s·ªë t·ª± nhi√™n
            // T·∫°o b√†i to√°n g√† th·ªè v·ªõi k·∫øt qu·∫£ ƒë·∫£m b·∫£o l√† s·ªë nguy√™n d∆∞∆°ng
            let totalAnimals, totalLegs, rabbits, chickens;
            let attempts = 0;
            
            do {
                totalAnimals = getRandomNumber(8, 15);
                totalLegs = getRandomNumber(24, 40);
                rabbits = (totalLegs - 2 * totalAnimals) / 2;
                chickens = totalAnimals - rabbits;
                attempts++;
            } while ((rabbits <= 0 || chickens <= 0 || !Number.isInteger(rabbits) || !Number.isInteger(chickens)) && attempts < 20);
            
            if (rabbits > 0 && chickens > 0 && Number.isInteger(rabbits) && Number.isInteger(chickens)) {
                const wrongAnswers2 = [
                    `${chickens} con`,
                    `${Math.max(1, rabbits - 1)} con`,
                    `${Math.min(totalAnimals - 1, rabbits + 1)} con`
                ];
                
                const allChoices2 = [`${rabbits} con`, ...wrongAnswers2];
                const choices2 = shuffleArray(allChoices2);
                
                questions.push({
                    q: `Trong m·ªôt chu·ªìng c√≥ ${totalAnimals} con g√† v√† th·ªè. ƒê·∫øm ƒë∆∞·ª£c t·∫•t c·∫£ ${totalLegs} ch√¢n. H·ªèi c√≥ bao nhi√™u con th·ªè?`,
                    choices: choices2,
                    correct: choices2.indexOf(`${rabbits} con`)
                });
            } else {
                // Fallback v·ªõi b√†i to√°n c·ªë ƒë·ªãnh c√≥ k·∫øt qu·∫£ ch·∫Øc ch·∫Øn l√† s·ªë t·ª± nhi√™n
                const allChoices2 = ["6 con", "4 con", "5 con", "7 con"];
                const choices2 = shuffleArray(allChoices2);
                
                questions.push({
                    q: `Trong m·ªôt chu·ªìng c√≥ 10 con g√† v√† th·ªè. ƒê·∫øm ƒë∆∞·ª£c t·∫•t c·∫£ 32 ch√¢n. H·ªèi c√≥ bao nhi√™u con th·ªè?`,
                    choices: choices2,
                    correct: choices2.indexOf("6 con")
                });
            }

            return questions;
        }

        // T·∫°o ƒë·ªÅ thi ho√†n ch·ªânh
        function generateCompleteExam() {
            return [
                {
                    title: "Ph·∫ßn 1 - Tr·∫Øc nghi·ªám S·ªë h·ªçc",
                    description: "√în t·∫≠p c√°c ph√©p t√≠nh v·ªõi s·ªë t·ª± nhi√™n: C·ªông, tr·ª´, nh√¢n, chia s·ªë c√≥ nhi·ªÅu ch·ªØ s·ªë. T√≠nh nh·∫©m nhanh, ph√¢n t√≠ch s·ªë. ƒê·ªçc, vi·∫øt, so s√°nh",
                    questions: generateMathQuestions()
                },
                {
                    title: "Ph·∫ßn 2 - Tr·∫Øc nghi·ªám ƒê·∫°i l∆∞·ª£ng v√† ƒëo l∆∞·ªùng",
                    description: "ƒê∆°n v·ªã ƒëo ƒë·ªô d√†i, di·ªán t√≠ch, th·ªÉ t√≠ch, kh·ªëi l∆∞·ª£ng. Chuy·ªÉn ƒë·ªïi ƒë∆°n v·ªã (m, dm, cm, mm; kg, g...). T√≠nh chu vi, di·ªán t√≠ch c√°c h√¨nh: vu√¥ng, ch·ªØ nh·∫≠t",
                    questions: generateMeasurementQuestions()
                },
                {
                    title: "Ph·∫ßn 3 - Tr·∫Øc nghi·ªám H√¨nh h·ªçc",
                    description: "Nh·∫≠n bi·∫øt v√† v·∫Ω h√¨nh: H√¨nh vu√¥ng, h√¨nh ch·ªØ nh·∫≠t, tam gi√°c, h√¨nh thoi. ƒê∆∞·ªùng th·∫≥ng song song, vu√¥ng g√≥c. T√≠nh di·ªán t√≠ch c√°c h√¨nh ƒë√£ h·ªçc",
                    questions: generateGeometryQuestions()
                },
                {
                    title: "Ph·∫ßn 4 - Gi·∫£i to√°n c√≥ l·ªùi vƒÉn",
                    description: "T√¨m m·ªôt ph·∫ßn (ho·∫∑c nhi·ªÅu ph·∫ßn) c·ªßa m·ªôt s·ªë. T√¨m s·ªë khi bi·∫øt gi√° tr·ªã c·ªßa m·ªôt ph√¢n s·ªë c·ªßa n√≥. B√†i to√°n v·ªÅ t·ªâ s·ªë, t·ªïng ‚Äì hi·ªáu ‚Äì ph·∫ßn. B√†i to√°n chuy·ªÉn ƒë·ªông ƒë∆°n gi·∫£n",
                    questions: generateWordProblems()
                },
                {
                    title: "Ph·∫ßn 5 - T∆∞ duy logic, n√¢ng cao",
                    description: "To√°n ƒë·ªë m·∫πo, to√°n suy lu·∫≠n. D·∫°ng \"ch·ªçn s·ªë ƒë√∫ng\", \"ƒëi·ªÅn s·ªë th√≠ch h·ª£p\", \"t√¨m quy lu·∫≠t d√£y s·ªë\"",
                    questions: generateLogicQuestions()
                }
            ];
        }

        // Bi·∫øn to√†n c·ª•c
        let examSections = [];
        let userAnswers = {};
        let examStarted = false;
        let examSubmitted = false;
        let selectedExamNumber = null;
        let startTime = null;
        let timerInterval = null;

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            generateExamSelector();
            loadResultsHistory();
            setupScrollHandler();
        });

        // Ti·∫øp t·ª•c v·ªõi ph·∫ßn JavaScript c√≤n l·∫°i...
        
        function generateExamSelector() {
            const examGrid = document.getElementById('exam-grid');
            examGrid.innerHTML = '';
            
            for (let i = 1; i <= 40; i++) {
                const examOption = document.createElement('div');
                examOption.className = 'exam-option';
                examOption.textContent = `ƒê·ªÅ ${i}`;
                examOption.onclick = () => selectExam(i);
                examGrid.appendChild(examOption);
            }
        }

        function selectExam(examNumber) {
            selectedExamNumber = examNumber;
            
            // Remove previous selection
            document.querySelectorAll('.exam-option').forEach(option => {
                option.classList.remove('selected');
            });
            
            // Add selection to clicked option
            event.target.classList.add('selected');
            
            // Enable start button
            document.getElementById('start-btn').disabled = false;
            
            // Generate exam data for selected exam using seed
            Math.seedrandom(examNumber);
            examSections = generateCompleteExam();
        }

        function startExam() {
            if (!selectedExamNumber) return;
            
            document.getElementById('intro-section').style.display = 'none';
            document.getElementById('exam-content').classList.add('active');
            examStarted = true;
            startTime = new Date();
            
            // Start timer
            startTimer();
            
            // Show timer in header
            document.getElementById('timer-display').style.display = 'block';
            
            generateExam();
        }

        function startTimer() {
            timerInterval = setInterval(() => {
                const now = new Date();
                const elapsed = Math.floor((now - startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function stopTimer() {
            if (timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
            }
        }

        function setupScrollHandler() {
            // Kh√¥ng c·∫ßn x·ª≠ l√Ω scroll n·ªØa - ƒë√£ g·ª° b·ªè sticky header
        }

        function generateExam() {
            const container = document.getElementById('questions-container');
            container.innerHTML = '';
            
            let globalQuestionNumber = 1;
            
            examSections.forEach((section, sectionIndex) => {
                // T·∫°o header cho t·ª´ng ph·∫ßn
                const sectionHeader = document.createElement('div');
                sectionHeader.className = 'section-header';
                sectionHeader.innerHTML = `
                    <div class="section-title">${section.title}</div>
                    <div class="section-description">${section.description}</div>
                `;
                container.appendChild(sectionHeader);
                
                // T·∫°o c√¢u h·ªèi cho t·ª´ng ph·∫ßn
                section.questions.forEach((question, questionIndex) => {
                    const uniqueId = `question-${sectionIndex}-${questionIndex}`;
                    const questionDiv = document.createElement('div');
                    questionDiv.className = 'question';
                    questionDiv.id = uniqueId;
                    questionDiv.setAttribute('data-section', sectionIndex);
                    questionDiv.setAttribute('data-question', questionIndex);
                    questionDiv.setAttribute('data-global-number', globalQuestionNumber);
                    
                    // T·∫°o HTML cho choices v·ªõi event handler ri√™ng bi·ªát
                    const choicesHTML = question.choices.map((choice, choiceIndex) => {
                        return `<div class="choice" data-choice-index="${choiceIndex}" data-question-id="${uniqueId}">
                            ${String.fromCharCode(65 + choiceIndex)}. ${choice}
                        </div>`;
                    }).join('');
                    
                    questionDiv.innerHTML = `
                        <div class="question-number">C√¢u ${globalQuestionNumber}:</div>
                        <div class="question-text">${question.q}</div>
                        <div class="choices">
                            ${choicesHTML}
                        </div>
                    `;
                    
                    container.appendChild(questionDiv);
                    
                    // Th√™m event listeners cho c√°c choices
                    const choices = questionDiv.querySelectorAll('.choice');
                    choices.forEach((choiceElement, choiceIndex) => {
                        choiceElement.addEventListener('click', function() {
                            selectChoice(uniqueId, sectionIndex, questionIndex, choiceIndex);
                        });
                    });
                    
                    globalQuestionNumber++;
                });
            });
        }

        function selectChoice(uniqueId, sectionIndex, questionIndex, choiceIndex) {
            if (examSubmitted) return;
            
            // T√¨m question div b·∫±ng unique ID
            const questionDiv = document.getElementById(uniqueId);
            if (!questionDiv) return;
            
            // Remove previous selection trong question n√†y
            questionDiv.querySelectorAll('.choice').forEach(choice => {
                choice.classList.remove('selected');
            });
            
            // Add new selection
            const selectedChoice = questionDiv.querySelectorAll('.choice')[choiceIndex];
            if (selectedChoice) {
                selectedChoice.classList.add('selected');
            }
            
            // Store answer v·ªõi key duy nh·∫•t
            const answerKey = `${sectionIndex}-${questionIndex}`;
            userAnswers[answerKey] = choiceIndex;
            
            updateProgress();
        }

        function updateProgress() {
            const totalQuestions = examSections.reduce((sum, section) => sum + section.questions.length, 0);
            const answeredCount = Object.keys(userAnswers).length;
            const percentage = (answeredCount / totalQuestions) * 100;
            
            document.getElementById('progress-fill').style.width = percentage + '%';
            document.getElementById('progress-text').textContent = `${answeredCount}/${totalQuestions} c√¢u`;
        }

        function submitExam() {
            if (examSubmitted) return;
            
            const totalQuestions = examSections.reduce((sum, section) => sum + section.questions.length, 0);
            const answeredCount = Object.keys(userAnswers).length;
            
            if (answeredCount < totalQuestions) {
                const unanswered = totalQuestions - answeredCount;
                const confirmSubmit = confirm(
                    `B·∫°n ch∆∞a tr·∫£ l·ªùi ${unanswered} c√¢u h·ªèi.\n\n` +
                    `B·∫°n c√≥ mu·ªën n·ªôp b√†i ngay b√¢y gi·ªù kh√¥ng?\n` +
                    `(C√°c c√¢u ch∆∞a tr·∫£ l·ªùi s·∫Ω ƒë∆∞·ª£c t√≠nh l√† sai)`
                );
                
                if (!confirmSubmit) return;
            }
            
            examSubmitted = true;
            stopTimer();
            
            // Disable all choices
            document.querySelectorAll('.choice').forEach(choice => {
                choice.style.pointerEvents = 'none';
                choice.style.opacity = '0.8';
            });
            
            let correctCount = 0;
            
            examSections.forEach((section, sectionIndex) => {
                section.questions.forEach((question, qIndex) => {
                    const answerKey = `${sectionIndex}-${qIndex}`;
                    const userAnswer = userAnswers[answerKey];
                    
                    // Find question div using unique ID
                    const uniqueId = `question-${sectionIndex}-${qIndex}`;
                    const questionDiv = document.getElementById(uniqueId);
                    
                    if (questionDiv) {
                        const choices = questionDiv.querySelectorAll('.choice');
                        
                        // Highlight correct answer
                        if (choices[question.correct]) {
                            choices[question.correct].classList.add('correct');
                        }
                        
                        // Highlight incorrect answer
                        if (userAnswer !== undefined && userAnswer !== question.correct && choices[userAnswer]) {
                            choices[userAnswer].classList.add('incorrect');
                        } else if (userAnswer === undefined) {
                            questionDiv.style.backgroundColor = '#fff3cd';
                            questionDiv.style.border = '2px solid #ffc107';
                        }
                        
                        // Count correct answers
                        if (userAnswer === question.correct) {
                            correctCount++;
                        }
                    }
                });
            });
            
            // Save result to localStorage
            saveResult(correctCount, totalQuestions);
            
            showResult(correctCount, totalQuestions);
        }

        function saveResult(correct, total) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000);
            const percentage = Math.round((correct / total) * 100);
            
            const result = {
                examNumber: selectedExamNumber,
                score: correct,
                total: total,
                percentage: percentage,
                timeSpent: timeSpent,
                date: endTime.toISOString(),
                timestamp: endTime.getTime()
            };
            
            // Get existing results
            let results = JSON.parse(localStorage.getItem('examResults') || '[]');
            
            // Add new result
            results.push(result);
            
            // Keep only last 50 results
            if (results.length > 50) {
                results = results.slice(-50);
            }
            
            // Save back to localStorage
            localStorage.setItem('examResults', JSON.stringify(results));
        }

        function loadResultsHistory() {
            const results = JSON.parse(localStorage.getItem('examResults') || '[]');
            const historyList = document.getElementById('history-list');
            
            if (results.length === 0) {
                historyList.innerHTML = '<p style="text-align: center; color: #6c757d;">Ch∆∞a c√≥ k·∫øt qu·∫£ n√†o</p>';
                return;
            }
            
            // Sort by timestamp (newest first)
            results.sort((a, b) => b.timestamp - a.timestamp);
            
            historyList.innerHTML = results.slice(0, 10).map(result => {
                const date = new Date(result.date);
                const timeStr = `${Math.floor(result.timeSpent / 60)}:${(result.timeSpent % 60).toString().padStart(2, '0')}`;
                
                let ratingEmoji = '';
                if (result.percentage >= 90) ratingEmoji = 'üåü';
                else if (result.percentage >= 80) ratingEmoji = 'üëç';
                else if (result.percentage >= 70) ratingEmoji = 'üòä';
                else if (result.percentage >= 60) ratingEmoji = 'üìö';
                else ratingEmoji = 'üí™';
                
                return `
                    <div class="result-item">
                        <div class="result-info">
                            <div class="result-score">${ratingEmoji} ƒê·ªÅ ${result.examNumber}: ${result.score}/${result.total} ƒëi·ªÉm (${result.percentage}%)</div>
                            <div class="result-time">‚è∞ ${timeStr} - üìÖ ${date.toLocaleDateString('vi-VN')} ${date.toLocaleTimeString('vi-VN', {hour: '2-digit', minute: '2-digit'})}</div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function clearHistory() {
            if (confirm('B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a to√†n b·ªô l·ªãch s·ª≠ k·∫øt qu·∫£?')) {
                localStorage.removeItem('examResults');
                loadResultsHistory();
            }
        }

        function showResult(correct, total) {
            const endTime = new Date();
            const timeSpent = Math.floor((endTime - startTime) / 1000);
            const timeStr = `${Math.floor(timeSpent / 60)}:${(timeSpent % 60).toString().padStart(2, '0')}`;
            const percentage = Math.round((correct / total) * 100);
            
            let rating = '';
            let emoji = '';
            
            if (percentage >= 90) {
                rating = 'Xu·∫•t s·∫Øc';
                emoji = 'üåü';
            } else if (percentage >= 80) {
                rating = 'Gi·ªèi';
                emoji = 'üëç';
            } else if (percentage >= 70) {
                rating = 'Kh√°';
                emoji = 'üòä';
            } else if (percentage >= 60) {
                rating = 'Trung b√¨nh';
                emoji = 'üìö';
            } else {
                rating = 'C·∫ßn c·ªë g·∫Øng th√™m';
                emoji = 'üí™';
            }
            
            const resultDiv = document.getElementById('result-section');
            resultDiv.innerHTML = `
                <div class="score">${correct}/${total} ƒëi·ªÉm (${percentage}%)</div>
                <div class="rating">${emoji} ${rating}</div>
                <p><strong>ƒê·ªÅ s·ªë:</strong> ${selectedExamNumber}</p>
                <p><strong>Th·ªùi gian l√†m b√†i:</strong> ${timeStr}</p>
                <p>B·∫°n ƒë√£ ho√†n th√†nh ƒë·ªÅ thi t·ªïng h·ª£p to√°n h·ªçc l·ªõp 4!</p>
                <button class="back-btn" onclick="resetExam()">üîÑ L√†m l·∫°i ƒë·ªÅ n√†y</button>
                <button class="back-btn" onclick="goHome()">üè† V·ªÅ trang ch·ªß</button>
            `;
            
            resultDiv.style.display = 'block';
            document.querySelector('.submit-btn').style.display = 'none';
            
            resultDiv.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Reload history to show new result
            setTimeout(() => {
                loadResultsHistory();
            }, 1000);
        }

        function resetExam() {
            examSubmitted = false;
            userAnswers = {};
            startTime = new Date();
            
            // Reset timer
            stopTimer();
            startTimer();
            
            // Reset UI
            document.querySelectorAll('.choice').forEach(choice => {
                choice.classList.remove('selected', 'correct', 'incorrect');
                choice.style.pointerEvents = 'auto';
                choice.style.opacity = '1';
            });
            
            document.querySelectorAll('.question').forEach(question => {
                question.style.backgroundColor = '';
                question.style.border = '';
            });
            
            document.getElementById('result-section').style.display = 'none';
            document.querySelector('.submit-btn').style.display = 'inline-block';
            
            updateProgress();
            window.scrollTo(0, 0);
        }

        function goHome() {
            window.location.href = 'index.html';
        }

        // Add seedrandom function for consistent random generation
        !function(f,a,c){var s,l=256,p="random",d=c.pow(l,6),g=c.pow(2,52),y=2*g,h=l-1;function n(n,t,r){function e(){for(var n=u.g(6),t=d,r=0;n<g;)n=(n+r)*l,t*=l,r=u.g(1);for(;y<=n;)n/=2,t/=2,r>>>=1;return(n+r)/t}var o=[],i=j(function n(t,r){var e,o=[],i=typeof t;if(r&&"object"==i)for(e in t)try{o.push(n(t[e],r-1))}catch(n){}return o.length?o:"string"==i?t:t+"\0"}((t=1==t?{entropy:!0}:t||{}).entropy?[n,S(a)]:null==n?function(){try{var n;return s&&(n=s.randomBytes)?n=n(l):(n=new Uint8Array(l),(f.crypto||f.msCrypto).getRandomValues(n)),S(n)}catch(n){var t=f.navigator,r=t&&t.plugins;return[+new Date,f,r,f.screen,S(a)]}}():n,3),o),u=new m(o);return e.int32=function(){return 0|u.g(4)},e.quick=function(){return u.g(4)/4294967296},e.double=e,j(S(u.S),a),(t.pass||r||function(n,t,r,e){return e&&(e.S&&v(e,u),n.state=function(){return v(u,{})}),r?(c[p]=n,t):n})(e,i,"global"in t?t.global:this==c,t.state)}function m(n){var t,r=n.length,u=this,e=0,o=u.i=u.j=0,i=u.S=[];for(r||(n=[r++]);e<l;)i[e]=e++;for(e=0;e<l;e++)i[e]=i[o=h&o+n[e%r]+(t=i[e])],i[o]=t;(u.g=function(n){for(var t,r=0,e=u.i,o=u.j,i=u.S;n--;)t=i[e=h&e+1],r=r*l+i[h&(i[e]=i[o=h&o+t])+(i[o]=t)];return u.i=e,u.j=o,r})(l)}function v(n,t){return t.i=n.i,t.j=n.j,t.S=n.S.slice(),t}function j(n,t){for(var r,e=n+"",o=0;o<e.length;)t[h&o]=h&(r^=19*t[h&o])+e.charCodeAt(o++);return S(t)}function S(n){return String.fromCharCode.apply(0,n)}if(j(c.random(),a),"object"==typeof module&&module.exports){module.exports=n;try{s=require("crypto")}catch(n){}}else"function"==typeof define&&define.amd?define(function(){return n}):c["seed"+p]=n}("undefined"!=typeof self?self:this,[],Math);
    </script>
</body>
</html>
</body>
</html>
